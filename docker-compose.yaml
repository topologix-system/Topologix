services:
  # Batfish Network Analysis Service
  batfish:
    image: batfish/allinone:latest
    container_name: batfish
    ports:
      - "8888:8888"
      - "9996:9996"
      - "9997:9997"
    volumes:
      - batfish-data:/data
      - snapshots-data:/notebooks/snapshots

    networks:
      - topologix-network
    restart: unless-stopped

  # Backend API Service (Python + Flask)
  backend:
    image: ${BACKEND_IMAGE:-ghcr.io/topologix-system/topologix/backend:latest}
    container_name: topologix-backend
    # Command: default to gunicorn for production; override BACKEND_COMMAND for dev
    # Production (default): gunicorn --worker-class gevent --bind 0.0.0.0:5000 app:app
    # Development: BACKEND_COMMAND="python app.py"
    command:
      - /bin/sh
      - -c
      - ${BACKEND_COMMAND:-gunicorn --worker-class gevent --bind 0.0.0.0:5000 app:app}
    ports:
      - "5000:5000"
    environment:
      # Flask Environment (development or production)
      - FLASK_ENV=${FLASK_ENV:-production}
      - FLASK_DEBUG=${FLASK_DEBUG:-False}

      # Batfish Service
      - BATFISH_HOST=${BATFISH_HOST:-batfish}
      - BATFISH_PORT=${BATFISH_PORT:-9996}

      # CORS origins for API access
      # Include localhost and common LAN access patterns
      # For production, override with your specific domain/IP
      - CORS_ORIGINS=${CORS_ORIGINS:-http://localhost:3000,http://127.0.0.1:3000}

      # Authentication (disabled by default for OSS distribution)
      - AUTH_ENABLED=${AUTH_ENABLED:-true}
      - AUTH_DEFAULT_ADMIN_USER=${AUTH_DEFAULT_ADMIN_USER:-admin}
      - AUTH_DEFAULT_ADMIN_PASS=${AUTH_DEFAULT_ADMIN_PASS}
      # Allow user self-registration (set to 'false' for admin-only registration)
      - ALLOW_REGISTRATION=${ALLOW_REGISTRATION:-true}

      # Security Keys (auto-generated if not set, but should be set in production)
      - SECRET_KEY=${SECRET_KEY}
      - JWT_SECRET_KEY=${JWT_SECRET_KEY}
      - CSRF_SECRET_KEY=${CSRF_SECRET_KEY}

      # JWT Access Token Expiration (1 hour default, OWASP ASVS L2 compliant)
      - JWT_ACCESS_TOKEN_EXPIRES=${JWT_ACCESS_TOKEN_EXPIRES:-3600}

      # Login security (OSS defaults - secure but not too restrictive)
      - LOGIN_MAX_ATTEMPTS_PER_IP=${LOGIN_MAX_ATTEMPTS_PER_IP:-10}
      - LOGIN_RATE_WINDOW_MINUTES=${LOGIN_RATE_WINDOW_MINUTES:-15}
      # Account lockout configuration (OWASP recommendation: 5-10 attempts)
      - ACCOUNT_LOCKOUT_THRESHOLD=${ACCOUNT_LOCKOUT_THRESHOLD:-5}
      - LOGIN_LOCKOUT_DURATION_MINUTES=${LOGIN_LOCKOUT_DURATION_MINUTES:-30}

      # Database configuration (only used when AUTH_ENABLED=true)
      # SQLite (default - stored in Docker volume for persistence)
      - DATABASE_URL=${DATABASE_URL:-sqlite:////app/data/topologix.db}

      # Email configuration for password reset
      - EMAIL_PROVIDER=${EMAIL_PROVIDER:-console}
      - EMAIL_FROM=${EMAIL_FROM:-noreply@topologix.local}
      - EMAIL_FROM_NAME=${EMAIL_FROM_NAME:-Topologix}
      - SMTP_HOST=${SMTP_HOST:-localhost}
      - SMTP_PORT=${SMTP_PORT:-587}
      - SMTP_USERNAME=${SMTP_USERNAME}
      - SMTP_PASSWORD=${SMTP_PASSWORD}
      - SMTP_USE_TLS=${SMTP_USE_TLS:-true}

      # Password Reset
      - PASSWORD_RESET_TOKEN_EXPIRY=${PASSWORD_RESET_TOKEN_EXPIRY:-3600}
      - PASSWORD_RESET_URL_BASE=${PASSWORD_RESET_URL_BASE:-http://localhost:3000}

      # Reverse proxy configuration (see .env.example for details)
      # Set to 'true' when behind reverse proxy (nginx, Caddy, etc.)
      # CRITICAL: Must match actual infrastructure to prevent IP spoofing
      - BEHIND_REVERSE_PROXY=${BEHIND_REVERSE_PROXY:-false}
      # Number of trusted proxies in chain:
      # - 1 for single nginx (typical Docker setup)
      # - 2 for Caddy/nginx -> nginx -> Flask
      - TRUSTED_PROXY_COUNT=${TRUSTED_PROXY_COUNT:-1}
      # PostgreSQL example (recommended for production):
      # - DATABASE_URL=postgresql://user:password@postgres:5432/topologix
      # MySQL example:
      # - DATABASE_URL=mysql+pymysql://user:password@mysql:3306/topologix
    volumes:
      # Snapshots directory (shared with Batfish)
      - snapshots-data:/snapshots
      # Database volume (SQLite persistence when AUTH_ENABLED=true)
      - backend-db:/app/data
      # Flask session storage (named volume for proper permissions)
      - flask-sessions:/app/flask_session
    networks:
      - topologix-network
    depends_on:
      - batfish
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Frontend Web UI (React + Vite)
  frontend:
    image: ${FRONTEND_IMAGE:-ghcr.io/topologix-system/topologix/frontend:latest}
    container_name: topologix-frontend
    ports:
      - "3000:80"
    # Runtime environment variables (not used by production build)
    # Kept for documentation purposes
    environment:
      - VITE_API_BASE_URL=${VITE_API_BASE_URL:-}
      # Authentication (must match backend AUTH_ENABLED)
      - VITE_AUTH_ENABLED=${VITE_AUTH_ENABLED:-true}
      # Timezone for frontend timestamp display
      - VITE_TIMEZONE=${VITE_TIMEZONE:-Asia/Tokyo}
    networks:
      - topologix-network
    depends_on:
      - backend
    restart: unless-stopped
    stdin_open: true
    tty: true

networks:
  topologix-network:
    driver: bridge
    name: topologix-network

volumes:
  # Batfish data persistence
  batfish-data:
    name: topologix-batfish-data

  # Shared snapshot storage between backend and Batfish
  snapshots-data:
    name: topologix-snapshots

  # Backend database (SQLite persistence when AUTH_ENABLED=true)
  backend-db:
    name: topologix-backend-db

  # Flask session storage (isolated from host for proper permissions)
  flask-sessions:
    name: topologix-flask-sessions
